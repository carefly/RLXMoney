# RLXMoney 插件使用说明

## 概述

RLXMoney 是一个基于 LeviLamina 框架的 Minecraft 经济插件，提供完整的虚拟货币系统。插件采用分层架构设计，具有高度的安全性、稳定性和可扩展性。

### 主要特性

- 💰 **完整的经济系统** - 支持余额查询、转账、交易记录等
- 💎 **多币种支持** - 支持自定义多个币种，每个币种可独立配置
- 🔒 **数据一致性** - 使用 SQLite 事务保证数据完整性
- 📊 **交易记录** - 完整的交易历史记录和排行榜功能
- ⚙️ **灵活配置** - 支持运行时配置热重载
- 🛡️ **权限控制** - 基于 LeviLamina 权限系统的管理员命令
- 🏗️ **模块化架构** - 清晰的分层设计，易于维护和扩展

## 安装要求

- **LeviLamina** 框架
- **SQLite** 数据库支持
- **nlohmann_json** 库

## 安装步骤

1. 确保服务器已安装 LeviLamina 框架
2. 将插件文件放置到 LeviLamina 插件目录
3. 重启服务器或使用 `/reload` 命令加载插件

## 配置文件

插件配置文件位于：`plugins/RLXModeResources/data/money/config.json`

### 默认配置结构

```json
{
  "database": {
    "path": "plugins/RLXModeResources/data/money/money.db",
    "optimization": {
      "walMode": true,
      "cacheSize": 2000,
      "synchronous": "NORMAL"
    }
  },
  "defaultCurrency": "gold",
  "currencies": {
    "gold": {
      "name": "金币",
      "symbol": "G",
      "displayFormat": "{amount} {symbol}",
      "enabled": true,
      "initialBalance": 1000,
      "maxBalance": 1000000000,
      "minTransferAmount": 1,
      "transferFee": 0,
      "feePercentage": 0.0,
      "allowPlayerTransfer": true
    },
    "silver": {
      "name": "银币",
      "symbol": "S",
      "displayFormat": "{amount} {symbol}",
      "enabled": true,
      "initialBalance": 0,
      "maxBalance": 1000000000,
      "minTransferAmount": 1,
      "transferFee": 0,
      "feePercentage": 0.0,
      "allowPlayerTransfer": true
    }
  },
  "topList": {
    "defaultCount": 10,
    "maxCount": 50
  }
}
```

### 配置参数说明

#### 数据库配置 (database)
- `path`: 数据库文件路径
- `walMode`: 是否启用 WAL 模式（提高性能）
- `cacheSize`: 缓存大小（页面数）
- `synchronous`: 同步模式（NORMAL/FULL/OFF）

#### 默认币种 (defaultCurrency)
- 指定默认使用的币种ID，当命令中未指定币种时使用此币种

#### 币种配置 (currencies)
每个币种包含以下配置项：

**基本信息：**
- `name`: 币种名称（显示用）
- `symbol`: 币种符号（如 "G", "¥", "$"）
- `displayFormat`: 显示格式模板（如 "{amount} {symbol}"）
- `enabled`: 是否启用该币种

**经济参数：**
- `initialBalance`: 新玩家该币种的初始余额
- `maxBalance`: 该币种的最大余额限制
- `minTransferAmount`: 该币种的最小转账金额
- `transferFee`: 该币种的固定转账手续费
- `feePercentage`: 该币种的转账手续费百分比（0.0-100.0）
- `allowPlayerTransfer`: 该币种是否允许玩家间转账

#### 排行榜配置 (topList)
- `defaultCount`: 默认显示数量
- `maxCount`: 最大显示数量限制

## 命令系统

### 玩家命令 (/money)

| 命令                                | 参数                     | 说明                                     | 示例                                                            |
| ----------------------------------- | ------------------------ | ---------------------------------------- | --------------------------------------------------------------- |
| `/money query [币种]`               | 可选币种ID               | 查询余额（不指定币种则显示所有币种）     | `/money query` 或 `/money query gold`                           |
| `/money history [币种]`             | 可选币种ID               | 查看交易记录（不指定币种则显示所有币种） | `/money history` 或 `/money history gold`                       |
| `/money pay <玩家名> <金额> [币种]` | 玩家名、金额、可选币种ID | 向其他玩家转账（不指定币种使用默认币种） | `/money pay PlayerName 100` 或 `/money pay PlayerName 100 gold` |

### 管理员命令 (/moneyop)

**注意：需要 OP 权限**

| 命令                                   | 参数                     | 说明                                     | 示例                                                                    |
| -------------------------------------- | ------------------------ | ---------------------------------------- | ----------------------------------------------------------------------- |
| `/moneyop set <玩家名> <金额> [币种]`  | 玩家名、金额、可选币种ID | 设置玩家余额                             | `/moneyop set PlayerName 5000` 或 `/moneyop set PlayerName 5000 gold`   |
| `/moneyop give <玩家名> <金额> [币种]` | 玩家名、金额、可选币种ID | 给予玩家金币                             | `/moneyop give PlayerName 1000` 或 `/moneyop give PlayerName 1000 gold` |
| `/moneyop take <玩家名> <金额> [币种]` | 玩家名、金额、可选币种ID | 扣除玩家金币                             | `/moneyop take PlayerName 500` 或 `/moneyop take PlayerName 500 gold`   |
| `/moneyop check <玩家名> [币种]`       | 玩家名、可选币种ID       | 查看玩家余额                             | `/moneyop check PlayerName` 或 `/moneyop check PlayerName gold`         |
| `/moneyop his <玩家名> [币种]`         | 玩家名、可选币种ID       | 查看玩家交易记录                         | `/moneyop his PlayerName` 或 `/moneyop his PlayerName gold`             |
| `/moneyop top [币种]`                  | 可选币种ID               | 查看财富排行榜（不指定币种使用默认币种） | `/moneyop top` 或 `/moneyop top gold`                                   |
| `/moneyop setinitial <金额>`           | 金额                     | 设置默认币种的新玩家初始金额             | `/moneyop setinitial 2000`                                              |
| `/moneyop getinitial`                  | 无                       | 查看默认币种的当前初始金额               | `/moneyop getinitial`                                                   |
| `/moneyop reload`                      | 无                       | 重新加载配置文件                         | `/moneyop reload`                                                       |

### 币种管理命令 (/moneyop currency)

**注意：需要 OP 权限**

| 命令                              | 参数   | 说明             | 示例                          |
| --------------------------------- | ------ | ---------------- | ----------------------------- |
| `/moneyop currency list`          | 无     | 列出所有币种     | `/moneyop currency list`      |
| `/moneyop currency info <币种ID>` | 币种ID | 查看币种详细信息 | `/moneyop currency info gold` |

## 功能详解

### 1. 多币种系统
- 支持同时配置和使用多个币种
- 每个币种可以独立设置名称、符号、显示格式
- 每个币种可以独立配置经济参数（初始余额、最大余额、手续费等）
- 玩家可以同时持有多个币种的余额
- 转账只能在同币种间进行，不支持跨币种转账

### 2. 余额查询
- 玩家可以查询指定币种的余额
- 不指定币种时显示所有币种的余额
- 支持管理员查询任意玩家的任意币种余额

### 3. 转账系统
- 玩家之间可以互相转账（同币种）
- 每个币种可以独立设置转账手续费（固定费用和百分比）
- 每个币种可以独立设置是否允许玩家转账
- 转账会有完整的交易记录

### 4. 交易记录
- 所有经济操作都会记录交易历史
- 支持按币种查询交易记录
- 记录包含币种、操作者、时间、描述等详细信息

### 5. 排行榜功能
- 支持按币种查看财富排行榜
- 实时显示服务器财富排行榜
- 支持自定义显示数量
- 管理员可以查看完整排行

### 6. 配置热重载
- 无需重启服务器即可更新配置
- 修改配置后使用 `/moneyop reload` 生效
- 配置文件中的币种会在系统启动时自动同步到数据库

## 数据库结构

插件使用 SQLite 数据库存储数据，包含以下表：

### players 表
存储玩家基本信息（不包含余额）

| 字段          | 类型    | 说明                   |
| ------------- | ------- | ---------------------- |
| xuid          | TEXT    | 玩家唯一标识符（主键） |
| username      | TEXT    | 玩家用户名             |
| firstJoinTime | INTEGER | 首次加入时间           |
| createdAt     | INTEGER | 记录创建时间           |
| updatedAt     | INTEGER | 记录更新时间           |

### currencies 表
存储币种定义信息

| 字段            | 类型    | 说明            |
| --------------- | ------- | --------------- |
| currency_id     | TEXT    | 币种ID（主键）  |
| currency_name   | TEXT    | 币种名称        |
| currency_symbol | TEXT    | 币种符号        |
| display_format  | TEXT    | 显示格式模板    |
| enabled         | INTEGER | 是否启用（0/1） |
| created_at      | INTEGER | 创建时间        |
| updated_at      | INTEGER | 更新时间        |

### player_balances 表
存储玩家各币种的余额

| 字段                            | 类型    | 说明     |
| ------------------------------- | ------- | -------- |
| xuid                            | TEXT    | 玩家XUID |
| currency_id                     | TEXT    | 币种ID   |
| balance                         | INTEGER | 余额     |
| updated_at                      | INTEGER | 更新时间 |
| PRIMARY KEY (xuid, currency_id) | -       | 复合主键 |

### currency_configs 表
存储每个币种的经济配置

| 字段                  | 类型    | 说明                    |
| --------------------- | ------- | ----------------------- |
| currency_id           | TEXT    | 币种ID（主键）          |
| initial_balance       | INTEGER | 初始余额                |
| max_balance           | INTEGER | 最大余额                |
| min_transfer_amount   | INTEGER | 最小转账金额            |
| transfer_fee          | INTEGER | 固定转账手续费          |
| fee_percentage        | REAL    | 手续费百分比            |
| allow_player_transfer | INTEGER | 是否允许玩家转账（0/1） |

### transactions 表
存储交易记录

| 字段         | 类型    | 说明                 |
| ------------ | ------- | -------------------- |
| id           | INTEGER | 记录ID（主键）       |
| xuid         | TEXT    | 玩家XUID             |
| currency_id  | TEXT    | 币种ID               |
| amount       | INTEGER | 交易金额             |
| balance      | INTEGER | 交易后余额           |
| type         | TEXT    | 交易类型             |
| description  | TEXT    | 交易描述             |
| timestamp    | INTEGER | 交易时间戳           |
| related_xuid | TEXT    | 关联玩家XUID（转账） |
| transfer_id  | TEXT    | 转账ID（配对记录）   |

## 交易类型说明

| 类型     | 说明     | 资金流向 |
| -------- | -------- | -------- |
| SET      | 设置余额 | 中性     |
| ADD      | 增加金钱 | 进账     |
| REDUCE   | 减少金钱 | 出账     |
| TRANSFER | 转账     | 双向     |
| INITIAL  | 初始金额 | 进账     |

## 常见问题

### Q: 如何重置玩家余额？
A: 使用 `/moneyop set <玩家名> <金额> [币种]` 命令，不指定币种则使用默认币种

### Q: 转账失败怎么办？
A: 检查以下几点：
- 目标玩家名称是否正确
- 转账金额是否大于该币种的最小转账限制
- 自己该币种的余额是否足够（含手续费）
- 该币种是否允许玩家转账

### Q: 如何修改初始金额？
A: 使用 `/moneyop setinitial <金额>` 修改默认币种的新玩家初始金额。要修改其他币种的初始金额，需要在配置文件中修改后重新加载配置

### Q: 如何添加新币种？
A: 在配置文件的 `currencies` 部分添加新币种配置，然后使用 `/moneyop reload` 重新加载配置，系统会自动将新币种同步到数据库

### Q: 如何删除币种？
A: 从配置文件中删除币种配置，然后重新加载配置。**注意：只有没有玩家持有该币种余额时才能删除**

### Q: 数据库文件在哪里？
A: 默认位于 `plugins/RLXModeResources/data/money/money.db`

### Q: 如何备份数据？
A: 直接复制整个 `money.db` 文件即可

### Q: 转账时如何指定币种？
A: 在命令末尾添加币种ID参数，例如 `/money pay PlayerName 100 gold`

### Q: 不指定币种时使用哪个币种？
A: 使用配置文件中 `defaultCurrency` 指定的默认币种

## 开发者 API

RLXMoney 提供了完整的 API 供其他插件调用：

```cpp
#include "RLXMoneyAPI.h"

// 获取玩家指定币种的余额
auto balance = RLXMoneyAPI::getBalance(playerXuid, "gold");

// 获取玩家所有币种余额
auto balances = RLXMoneyAPI::getAllBalances(playerXuid);

// 给予金币（指定币种）
bool success = RLXMoneyAPI::addMoney(playerXuid, "gold", 1000);

// 扣除金币（指定币种）
bool success = RLXMoneyAPI::reduceMoney(playerXuid, "gold", 500);

// 转账（同币种）
bool success = RLXMoneyAPI::transferMoney(fromXuid, toXuid, "gold", amount);

// 获取所有启用的币种ID列表
auto currencyIds = RLXMoneyAPI::getEnabledCurrencyIds();

// 获取默认币种ID
std::string defaultCurrency = RLXMoneyAPI::getDefaultCurrencyId();

// 获取财富排行榜（按币种）
auto topList = RLXMoneyAPI::getTopBalanceList("gold", 10);
```

## 安全注意事项

1. **权限控制** - 确保只有可信的管理员拥有 OP 权限
2. **数据备份** - 定期备份数据库文件
3. **配置保护** - 限制配置文件的访问权限
4. **日志监控** - 定期检查服务器日志中的异常记录

## 技术支持

如有问题或建议，请联系插件开发者或查看项目文档。

---

**版本**: 2.0.0
**框架**: LeviLamina
**数据库**: SQLite
**作者**: RLX Team

## 更新日志

### 版本 2.0.0
- ✨ 新增多币种支持，可以自定义多个币种
- ✨ 每个币种可独立配置经济参数
- ✨ 支持按币种查询余额和交易记录
- ✨ 支持按币种查看排行榜
- 🔄 数据库结构更新，使用独立余额表存储多币种余额
- 🔄 API 更新，所有方法添加币种参数